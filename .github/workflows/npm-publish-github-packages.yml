# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages

name: Node.js Package

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm run build
      - run: npm test

  deploy-to-github-pages:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: write # 需要写入权限来推送更改到gh-pages分支
      pages: update # 需要更新权限来部署到GitHub Pages
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false # 不需要Git凭证，因为我们只是部署静态文件
          ref: gh-pages # 切换到gh-pages分支（如果存在）；如果不存在，后面的步骤将创建它

      - name: Set up Node.js for building and testing
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # 这里不需要设置registry-url，因为我们不是发布npm包

      # 注意：下面的步骤假设您的构建已经在之前的作业中完成，并且dist文件夹已经存在
      - name: Copy files to the gh-pages branch
        run: |
          rm -rf * # 清空当前工作目录（gh-pages分支的内容）
          cp -r dist/* . # 将dist文件夹的内容复制到当前目录

      - name: Commit and push changes to gh-pages branch
        run: |
          git config --local user.name "github-actions"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Deploy to GitHub Pages" || true # 如果没有更改则不提交
          git push